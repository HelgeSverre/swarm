#!/usr/bin/env php
<?php

/**
 * Swarm Worker - Background process for async agent execution
 *
 * This script is launched by ProcessSpawner to handle requests
 * in a separate process while streaming progress updates via stdout.
 *
 * Usage: php worker <base64_encoded_input> [timeout]
 */

// Get the bootstrapped application
try {
    $app = require dirname(__DIR__) . '/bootstrap/app.php';
} catch (HelgeSverre\Swarm\Exceptions\ConfigurationException $e) {
    fwrite(STDERR, "Configuration Error: " . $e->getMessage() . "\n");
    exit($e->getExitCode());
}

use HelgeSverre\Swarm\CLI\Process\WorkerProcess;

// Check command line arguments
if ($argc < 2) {
    fwrite(STDERR, "Usage: php worker <base64_encoded_input> [timeout]\n");
    exit(1);
}

// Get arguments
$encodedInput = $argv[1];
$timeout = isset($argv[2]) ? (int) $argv[2] : 300;

// Decode input
$input = base64_decode($encodedInput);
if ($input === false) {
    fwrite(STDERR, "Error: Failed to decode input\n");
    exit(1);
}

try {
    // Process the request with streaming updates
    WorkerProcess::processRequest($input, $timeout);
    exit(0);
} catch (Exception $e) {
    // Write error to stderr
    fwrite(STDERR, 'Error: ' . $e->getMessage() . "\n");

    // Also send error via stdout protocol
    echo json_encode([
        'type' => 'status',
        'status' => 'error',
        'error' => $e->getMessage(),
        'timestamp' => microtime(true),
    ]) . "\n";

    exit(1);
}